const Jimp = require('jimp');
const jsQR = require('jsqr');

// expected usage: node index.js <DATA_URL>
const dataUrl = process.argv[2] || `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACkCAYAAAAZtYVBAAAAAklEQVR4AewaftIAAAYXSURBVO3BQW4su5bAQFKo/W+Z7aFGAhJZ9tP9fSLsB2NcYjHGRRZjXGQxxkUWY1xkMcZFFmNcZDHGRRZjXGQxxkUWY1xkMcZFFmNcZDHGRRZjXGQxxkU+vKTylyp2KruKJ1R2FScqb1ScqOwqdiq7ihOVv1TxxmKMiyzGuMhijIt8+LKKb1I5qdipnFTsKp6o2KmcVOxUnlDZVbxR8U0q37QY4yKLMS6yGOMiH36ZyhMVb1TsVJ5Q2VXsVHYV31SxU9mpnFQ8ofJExW9ajHGRxRgXWYxxkQ//OJUnVE4qdipPqLyhsqvYqewq/pcsxrjIYoyLLMa4yIf/MRU7lW+qOKnYqTxRcVKxU9lV/MsWY1xkMcZFFmNc5MMvq/hLKicVO5WdyhMqJxU7lV3FicquYlfxRsVNFmNcZDHGRRZjXOTDl6n8lyp2Kk9U7FSeqNip7Cp2KruKJ1R2FScqN1uMcZHFGBdZjHGRDy9V3ETliYqTip3KicoTFTuVb6r4lyzGuMhijIssxriI/eAFlV3FEyq7ip3KExU7lScq3lD5poqdyl+qOFHZVbyxGOMiizEushjjIh9eqtip7Cp2Kicqu4rfVLFT2VXsVE4qdiq7im+qeEJlV3GisqvYVXzTYoyLLMa4yGKMi9gPfpHKScWJyq7iCZVdxRsqT1ScqPymim9S2VV802KMiyzGuMhijIvYD15Q2VU8obKrOFF5omKnclKxU9lVnKicVJyo7Cp2KruKncqu4ptUTireWIxxkcUYF1mMcZEPX6ayqzipOFHZVexUnqg4UTlR2VXsKnYqJyq7ijcqdiq7ip3KScVfWoxxkcUYF1mMcRH7wS9SeaLiCZWTip3KruINlV3Ficqu4kTljYqdyq5ip/JExTctxrjIYoyLLMa4yIcvUzmpOFE5qdhVnKjsKnYqu4o3VHYVT6g8UbFT+aaKncpvWoxxkcUYF1mMcRH7wRepvFHxm1R2FScqu4oTlV3FTuUvVexUTir+S4sxLrIY4yKLMS5iP/gPqTxRcaLyTRU7lV3FTmVXcaLyRMVO5YmKncqu4kRlV/FNizEushjjIosxLmI/eEFlV7FT2VW8ofJExU7lpOJE5Y2KE5VdxU5lV7FT2VXsVHYVO5UnKr5pMcZFFmNcZDHGRT68VLFTeUPlpGKnsqvYqewqdipvVJyonKjsKt6oOKnYqdxkMcZFFmNcZDHGRT78soqdyknFGyonKruKE5U3KnYqu4oTlV3FEyonFU+o/KbFGBdZjHGRxRgX+fCSyq5ip3JSsVM5qTip2KnsKnYqJxUnKruKf4nKruKkYqeyq3hjMcZFFmNcZDHGRT78sYqTihOVE5UnKk5UdhW7ihOVE5Vdxa5ip7Kr2KnsKnYqu4qdyn9pMcZFFmNcZDHGRT68VHFS8YTKScVO5S+p7Cp2KruKE5U3VHYVT6jsKk5UdhXftBjjIosxLrIY4yL2g4uo7CreUDmp2KnsKnYqb1ScqJxU7FR2FScqJxX/pcUYF1mMcZHFGBexH7yg8k0VO5WTijdUTipOVE4qdio3q/gvLca4yGKMiyzGuIj94B+m8kTFicobFTuVXcUbKicVT6i8UfFNizEushjjIosxLvLhJZW/VHFScaKyq9hV7FSeUNlVPKFyUrFTOVHZVZxUnKj8psUYF1mMcZHFGBf58GUV36RyUrFTuYnKScVJxRsVT6jsKnYVv2kxxkUWY1xkMcZFPvwylScqnlA5qThROal4Q+VEZVfxhsobFScqJxVvLMa4yGKMiyzGuMiHf1zFTmWnsqs4qXhC5aRip7Kr2KmcVJxU7FSeUHmi4psWY1xkMcZFFmNc5MP/Myq7ip3KruKJip3KExVPVOxUTip2KicVf2kxxkUWY1xkMcZFPvyyir9U8U0qu4pdxU5lV7FT2amcVOxU3lC52WKMiyzGuMhijIvYD15Q+UsVO5VdxYnKruJE5aRip3JScaLyRsVfUtlVvLEY4yKLMS6yGOMi9oMxLrEY4yKLMS6yGOMiizEushjjIosxLrIY4yKLMS6yGOMiizEushjjIosxLrIY4yKLMS6yGOMi/wfh5ws3Kwz4twAAAABJRU5ErkJggg==`;

const [, encoding, content] = dataUrl.match(/^data:image\/png;([^,]+),(.+)$/) || [];
const buffer = Buffer.from(content, encoding);

// alternate method if using an image file...
// const buffer = require('fs').readFileSync(__dirname + '/image.png');

const main = async () => {
  const image = await Jimp.read(buffer);
  const { data: result } = jsQR(image.bitmap.data, image.bitmap.width, image.bitmap.height);
  console.log(result);
};

main().catch(err => {
  console.error(err);
  process.exit(1);
});
